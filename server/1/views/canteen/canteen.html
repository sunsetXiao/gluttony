{% extends 'layout.html' %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="/css/jquery.rating.css">
<link rel="stylesheet" type="text/css" href="/css/canteen.css">
<style type="text/css">
.inner{
	width:1080px;
	margin: 0 auto;
}

.row-fluid .span4 {
    width: 30.623931623931625%;
    *width: 30.570740134569924%;
 }
  .row-fluid .span5{
  	width: 40.623931623931625%;
  }

.dish-comment{
	margin-bottom: 10px;
}

.dish-comment .content{
 	background: #eee;
 	min-height: 50px;
 	padding: 5px 10px;
 	
 }
 .imgContainer img{
 	
 }
.dish-comment .avatar img{
 	width: 50px;
 	height: 50px;
 	margin-left: auto;
 	margin-right: auto;
 }
textarea{
width: 83%;
 }

</style>
{% endblock %}
{% block content %}
<div class="container">
	<div class="row-fluid content-background">
		<div class="span3">
			<h1> {{canteen.name}} </h1>
			<img src="{{canteen.previewUrl}}">
			<p> {{canteen.description}}</p>
		</div>
		<div class="span9">
			<h1>食物列表</h1>
			<hr class="title-splitor" height="40px;">
				{% for dish in canteen.dishes %}
					<div class="dish-item">
					<div class="dish-bar row-fluid">
						<div class="span2">
							<a href="javascript:void;"  class="dish-name"><h4>{{dish.name}}</h4></a>
						</div>
						<div class="span2">
							<p class="remark">
								{% if dish.price %}
									价格:{{dish.price}}
								{% endif %}
							</p>
							<p class="remark">
								{% if dish.location %}
									位置:{{dish.location}}
								{% endif %}
							</p>
						</div>
						<div class="span4">
							{% if dish.description %}
								{{dish.description}}
							{% else %}
								暂无描述
							{% endif %}
						</div>
						<div class="span4" style="display:table-cell;vertical-align:middle;">
							<div class="pull-right">
								<a href="javascript:void" data-dish-id="{{dish._id}}" class="like-dish-btn">
									{% if dish.isLike %}
										<i class="icon small_like_active"></i>
									{% else %}
										<i class="icon small_like_inactive"></i>
									{% endif %}
								</a>
								<span>
									{{dish.likeNumber}}
								</span>
							</div>
						</div>
					</div>
					<div class="dish-detail row-fluid">
						<div class="span4 col">
							{% if dish.previewUrl %}
							<div class="imgContainer"><a><img src=" {{ dish.previewUrl }}"></a>
								<div class="caption">
									{% if dish.description %}{{dish.description}}
									{% else %}暂无描述{% endif %}
								</div>
							</div>
							{% else %}
								<div class="imgContainer"><a><img src=" /img/default-dish.jpg"></a>
								<div class="caption">
									{% if dish.description %}{{dish.description}}
									{% else %}暂无描述{% endif %}
								</div>
							</div>
							{% endif %}
						</div>
						<div class="span8 col">
							<div class="dish-comment row-fluid">
								<div class="span2">
									{% if user%}
										<div class="avatar">
											<img src="{{user.avatarUrl}}">
										</div>
										<p>{{user.name}}</p>
									{% else %}
										<div class="avatar">
											<img src="/img/defaultHead.png">
										</div>
										<p></p>
									{% endif %}
								</div>
								<div class="span10">
									<form class="form dish-comment-form" action="/dish/{{dish._id}}/comment/" method="post">
										<textarea rows="3" cols="30" name="commentContent"></textarea>
									  	<button type="submit" class="btn pull-right">评论</button>
									</form>
								</div>
							</div>
							{% for comment in dish.comments %}
								<div class="dish-comment row-fluid">
									<div class="span2">
										<div class="avatar">
											<img src="{{comment.commentor.avatarUrl}}">
										</div>
										<p>{{comment.commentor.name}}</p>
									</div>
									<div class="span10 content">
										<div class="">
											<div class="arrow"></div>
											{{comment.content}}
											<div class="pull-right" style="font-size:8px;">{{comment.time|date('Y年n月j日 G:i')}}</div>
										</div>
									</div>
								</div>
							{% endfor %}
						</div>
					</div>
				</div>
				{% endfor %}
		</div>
		
	</div>
</div>

<div class="modal hide fade" id="dishDisplayModal" tabindex="-1" role="dialog" aria-hidden="true">
	
</div>
{% endblock %}

{% block extra_js %}
<SCRIPT TYPE="text/javascript" src="/js/jquery.rating.js"></SCRIPT>
<script type="text/javascript" src="/js/canteen.js"></script>
<script type="text/javascript" src="/js/jquery.form.js"></script>
<script type="text/javascript">
CanteenController.toggleDishLike = function(){

}
$(".dish-item").each(function(){
	var self = $(this);
	self.find(".dish-bar .dish-name").click(function(){
		self.find(".dish-detail").toggle(500);
	});
});

$(".like-dish-btn").click(function(err){
	var self = $(this);
	var dishId = self.attr("data-dish-id");
	$.ajax({
		url:'/dish/' + dishId + '/toggleLike/',
		type:"post",
		dataType:"json",
		success:function(res){
			var i = self.find("i");
			if(res.isLike){
				i.addClass("small_like_active");
				i.removeClass("small_like_inactive");
			}else{
				i.removeClass("small_like_active");
				i.addClass("small_like_inactive");
			}
			var span = self.next("span");
			span.html(res.count);
		},
		error:function(){
			Util.notifyError();
		}
	})
});
$(".dish-comment-form").ajaxForm({
	success:function(){
		Util.notifySuccess();
	},
	error:function(){
		Util.notifyError();
	},
	clearForm:true
});
</script>

{% endblock %}